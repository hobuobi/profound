<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Recorder</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <main> 
        <div id="header">profound || </h1><span id="status"></div></div>
        <div id="main">
            <h1>What can we do to improve Bushrod Park?</h1>
            <button id="recordButton">Start Recording</button>
            <!-- <button id="stopBtn" disabled>Stop Recording</button> -->
            <textarea id="transcript" value=""></textarea>
            <div id="claims"></div>
        </div>

        
    </main>
    <script>
        let recognition;
        let isRecording = false;
        
        const recordBtn = document.getElementById('recordButton');
        //const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const transcript = document.getElementById('transcript');
        const claimsBox = document.getElementById('claims');

        // Initialization: Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            let finalTranscript = '';
            
            recognition.onresult = function(event) {
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcriptPart = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcriptPart;
                    } else {
                        interimTranscript += transcriptPart;
                    }
                }
                
                transcript.value = finalTranscript + '<i>' + interimTranscript + '</i>';
            };
            
            recognition.onstart = function() {
                status.textContent = 'Recording...';
                recordBtn.removeEventListener('click',startRecording);
                recordBtn.addEventListener('click',stopRecording);
                recordBtn.innerHTML = "Stop Recording";
                //stopBtn.disabled = false;
                isRecording = true;
            };
            
            recognition.onend = function() {
                status.textContent = 'Recording stopped';
                recordBtn.removeEventListener('click',stopRecording);
                recordBtn.addEventListener('click',startRecording);
                recordBtn.innerHTML = "Start Recording";
                //stopBtn.disabled = true;
                isRecording = false;
                extractClaims(finalTranscript).then(claims => {
                        claimsBox.innerHTML = `<h3>Extracted Claims:</h3><ul>${claims.split('\n').map(claim => `<li>${claim}</li>`).join('')}</ul>`;
                    }).catch(error => {
                        console.error('Error extracting claims:', error);
                        claimsBox.innerHTML = '<p>Error extracting claims.</p>';
                    });
                finalTranscript = ''; // Reset final transcript after processing
            };
            
            recognition.onerror = function(event) {
                status.textContent = 'Error: ' + event.error;
                recordBtn.disabled = false;
                //stopBtn.disabled = true;
                isRecording = false;
            };
            
        } else {
            status.textContent = 'Speech recognition not supported';
            recordBtn.disabled = true;
        }

        function startRecording() {
            if (recognition && !isRecording) {
                transcript.value = '';
                recognition.start();
            }
        }
        function stopRecording() {
            if (recognition && isRecording) {
                recognition.stop();
            }
        }

        recordBtn.addEventListener('click', startRecording);
        
        //stopBtn.addEventListener('click', stopRecording);

        async function extractClaims(transcript) {
        const response = await fetch('/api/extract-claims', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ transcript: transcript })
        });
    
    const data = await response.json();
    return data.claims;
}
    </script>
</body>
</html>